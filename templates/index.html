<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Crime Analytics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <!-- Google Font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  />

  <style>
    :root {
      --bg-dark: #050614;
      --card-bg: #0f1424;
      --accent: #ff4b5c;
      --accent-soft: rgba(255, 75, 92, 0.2);
      --text-light: #f8fafc;
      --text-muted: #cbd5e1;
    }

    * { font-family: "Poppins", sans-serif; }

    body {
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000000 100%);
      color: var(--text-light);
      min-height: 100vh;
    }

    /* Improve readability */
    .text-muted,
    .small,
    .form-label,
    .card-dark,
    .card-dark * {
      color: #cbd5e1 !important;
    }

    .card-header-dark h5,
    .card-header-dark h6 {
      color: #f8fafc !important;
    }

    table.forecast-table td,
    table.forecast-table th {
      color: #f1f5f9 !important;
    }

    .crime-tag {
      color: #e2e8f0 !important;
      border-color: rgba(255,255,255,0.2) !important;
    }

    .badge {
      color: #f8fafc !important;
    }

    select.form-select {
      color: #f8fafc !important;
      background-color: #0f172a !important;
    }

    .navbar {
      background: rgba(3, 7, 18, 0.9);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    .brand-pill {
      border-radius: 999px;
      padding: 4px 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .hero {
      margin-top: 72px;
      border-radius: 24px;
      background:
        linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(127, 29, 29, 0.9)),
        url("/static/img/crime-hero.jpg") center/cover;
      padding: 28px 24px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.65);
    }

    .hero-title {
      font-size: 1.9rem;
      font-weight: 600;
    }

    .stat-card {
      background: #020617;
      border-radius: 18px;
      padding: 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .stat-value {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .card-dark {
      background: var(--card-bg);
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.7);
    }

    .form-select,
    .form-control {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.85rem;
    }

    .btn-outline-soft {
      border-radius: 999px;
      padding: 8px 16px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.8);
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .map-wrapper iframe {
      width: 100%;
      height: 430px;
      border: none;
    }

    .severity-high { background: rgba(239,68,68,0.18); color:#fecaca; border:1px solid rgba(248,113,113,0.7); }
    .severity-medium { background: rgba(234,179,8,0.12); color:#facc15; border:1px solid rgba(252,211,77,0.6); }
    .severity-low { background: rgba(34,197,94,0.12); color:#bbf7d0; border:1px solid rgba(74,222,128,0.6); }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar fixed-top navbar-dark">
    <div class="container-fluid px-3 px-md-5">
      <div class="d-flex align-items-center gap-3">
        <span class="stat-icon"><i class="fas fa-shield-halved"></i></span>
        <div>
          <div class="brand-pill mb-1">Crime Analytics</div>
          <div class="fw-semibold">Crime Pattern & Forecasting Tool</div>
        </div>
      </div>
    </div>
  </nav>

  <main class="container-fluid px-3 px-md-5 pb-5">

    <!-- HERO -->
    <section class="hero mt-4 mt-md-5">
      <div class="row g-4 align-items-center">
        <div class="col-lg-8">
          <h1 class="hero-title mb-2">Visualize crime hotspots & anticipate risk before it escalates.</h1>
          <p class="text-muted mb-3">
            Filter incidents by time, gender and crime domain, view a live heatmap of cities,
            and generate forecasts.
          </p>
        </div>

        <div class="col-lg-4">
          <div class="row g-3">
            <div class="col-6">
              <div class="stat-card h-100">
                <div class="stat-value">{{ record_count }}</div>
                <div class="text-muted" style="font-size: 0.75rem;">Total incidents</div>
              </div>
            </div>
            <div class="col-6">
              <div class="stat-card h-100">
                <div class="stat-value">{{ city_count }}</div>
                <div class="text-muted" style="font-size: 0.75rem;">Cities covered</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- MAIN GRID -->
    <section class="mt-4">
      <div class="row g-4">

        <!-- FILTERS -->
        <div class="col-lg-4">
          <div class="card-dark p-3 p-md-4 h-100">

            <form method="POST" action="/">
              <!-- Time Range -->
              <div class="mb-3">
                <label class="form-label small text-uppercase text-muted mb-1">Time window</label>
                <select class="form-select" name="time_range" id="time_range">
                  {% for t in time_options %}
                    <option value="{{ t }}" {% if t == selected_time %}selected{% endif %}>{{ t }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Gender -->
              <div class="mb-3">
                <label class="form-label small text-uppercase text-muted mb-1">Victim gender</label>
                <select class="form-select" name="gender" id="gender">
                  <option value="All" {% if selected_gender == "All" %}selected{% endif %}>All</option>
                  <option value="M" {% if selected_gender == "M" %}selected{% endif %}>Male</option>
                  <option value="F" {% if selected_gender == "F" %}selected{% endif %}>Female</option>
                </select>
              </div>

              <!-- Domain -->
              <div class="mb-3">
                <label class="form-label small text-uppercase text-muted mb-1">Crime domain</label>
                <select class="form-select" name="domain" id="domain">
                  {% for d in domain_options %}
                    <option value="{{ d }}" {% if d == selected_domain %}selected{% endif %}>{{ d }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- City -->
              <div class="mb-4">
                <label class="form-label small text-uppercase text-muted mb-1">Focus city</label>
                <select class="form-select" name="city" id="city">
                  <option value="" {% if not selected_city %}selected{% endif %}>All cities</option>
                  {% for c in city_options %}
                    <option value="{{ c }}" {% if c == selected_city %}selected{% endif %}>{{ c }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Removed Update Button -->
              <div class="d-flex flex-wrap gap-2">
                <a href="/" class="btn btn-outline-soft">Reset</a>
              </div>
            </form>

          </div>

          <!-- CITY PREDICTION -->
          <div class="card-dark p-3 p-md-4 mt-4">
            <form method="POST" action="/predict_city_crimes">
              <div class="mb-3">
                <label class="form-label small text-uppercase text-muted mb-1">Select city</label>
                <select class="form-select" name="city">
                  {% for c in city_options %}
                    <option value="{{ c }}" {% if city_prediction and city_prediction.city == c %}selected{% endif %}>
                      {{ c }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <button class="btn btn-outline-soft w-100" type="submit">
                Predict crime pattern
              </button>
            </form>

            {% if city_prediction %}
              <div class="mt-3 p-3 rounded-4" style="background: rgba(15,23,42,0.8); border:1px dashed rgba(148,163,184,0.4);">

                {% if city_prediction.error %}
                  <div class="text-danger small">{{ city_prediction.error }}</div>
                {% else %}
                  <div class="fw-semibold mb-2">{{ city_prediction.city }}</div>

                  {% set sev = city_prediction.predicted_severity %}
                  <span class="badge badge-pill {% if sev == 'High' %}severity-high{% elif sev == 'Medium' %}severity-medium{% else %}severity-low{% endif %}">
                    Severity: {{ sev }}
                  </span>

                  <div class="small mt-2">
                    <span class="text-muted">Likely crime descriptions:</span><br/>
                    {% for desc in city_prediction.likely_crimes %}
                      <span class="crime-tag mt-1 d-inline-block">{{ desc }}</span>
                    {% endfor %}
                  </div>

                  <div class="small mt-2">
                    <span class="text-muted">Likely domains:</span><br/>
                    {% for dom in city_prediction.likely_domains %}
                      <span class="crime-tag mt-1 d-inline-block">{{ dom }}</span>
                    {% endfor %}
                  </div>

                  <div class="small text-muted mt-2">
                    Confidence: <b>{{ city_prediction.confidence }}</b>
                  </div>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- MAP + FORECAST -->
        <div class="col-lg-8">

          <!-- MAP -->
          <div class="card-dark p-3 p-md-4 mb-4">
            <h5><i class="fa-solid fa-map-location-dot me-2 text-primary"></i>Crime heatmap</h5>

            <div class="mt-3 map-wrapper" id="heatmap-container">
              <iframe src="{{ url_for('static', filename='map.html') }}?v={{ record_count }}"></iframe>
            </div>
          </div>

          <!-- FORECAST -->
          <div class="card-dark p-3 p-md-4">

            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5><i class="fa-solid fa-chart-line me-2 text-success"></i>7-day forecast</h5>

              <form method="POST" action="/predict_crime">
                <button type="submit" class="btn btn-gradient">Generate forecast</button>
              </form>
            </div>

            {% if forecast_graph %}
              <div class="row g-3">
                <div class="col-md-7">
                  <img src="data:image/png;base64,{{ forecast_graph }}" class="img-fluid rounded-4" />
                </div>

                <div class="col-md-5">
                  <table class="table table-sm table-borderless forecast-table">
                    <thead>
                      <tr><th>Date</th><th class="text-end">Count</th></tr>
                    </thead>
                    <tbody>
                      {% for d,c in forecast_table %}
                      <tr>
                        <td>{{ d }}</td>
                        <td class="text-end"><span class="badge bg-dark">{{ c }}</span></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>

            {% else %}
              <div class="text-center text-muted small">Click “Generate forecast”.</div>
            {% endif %}

          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jQuery for AJAX -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- AJAX Map Update -->
  <script>
    function updateMap() {
      $.ajax({
        url: "/update_map",
        method: "POST",
        data: {
          time_range: $("#time_range").val(),
          gender: $("#gender").val(),
          domain: $("#domain").val(),
          city: $("#city").val()
        },
        success: function(res) {
          $("#heatmap-container").html(res.map_html);
        }
      });
    }

    // Trigger map update on filter change
    $("#time_range, #gender, #domain, #city").on("change", updateMap);
  </script>

</body>
</html>
